<html>
<head>
    <script type="text/javascript" src="../bower_components/requirejs/require.js"></script>
    <script type="text/javascript" src="js/require-deps.js"></script>
    <link rel="stylesheet" href="css/colorbox.css">    
</head>
<body>

<table>
<tr><td>Username: </td><td><input id="username" type="text" title="User Name"></td></tr>
</table>

<input type="button" name="login" value="Login" onclick="doLogin()">


<div id="output"></div>

<script type="text/javascript">


	function doLogin() {

		require(["saml-ecp-js", "jquery", "jquery-colorbox"], function(samlEcpJs) {

			var username = $("#username").val();
			
			var client = new samlEcpJs.client({
				idpEndpointUrl : "http://wyvern.weedon.int:8030/idp/profile/SAML2/SOAP/ECP" 
			});

			// Not that this URL MUST match exactly the url in the metadata or else
			// the correct cookie will not be used during the first half of authentication
			var url = "http://media-center.weedon.int:8080/spring-security-saml2-sample/";
	
			client.get(url, {
					username : username,
					success : function(data, status) {
						console.debug("Status: ", status);
						$("#output").html(data);
					},
					ecpError : function(ecpErrorObj) {
						
						console.debug("Got error");
						if(ecpErrorObj.errorCode == samlEcpJs.ECP_ERROR.IDP_RESPONSE_ERROR)
							console.debug("IdP Error:", ecpErrorObj.idpStatus);
					},
					error : function(xmlHttp, msg) {
						console.error(msg);
					},
					ecpAuth : function(authCtx) {
						
			            $.colorbox({
			                html: "\
			                    <table>\
			                    <tr><td>Password: </td><td><input id='password' type='password'></td></tr>\
			                    </table>\
			                    <input type='button' name='continue' value='continue' onclick='$.colorbox.close()'>\
			                ",
			                onCleanup : function() {
			                    var password = $("#password").val();
			                    
			                    authCtx.setPassword(password);
			                    authCtx.retryAuth();
			                }
			            });
					}
				}
			);
		});
	}
	
	function continueLogin() {
		
	}
</script>

    
</body>
</html>